<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Sanal Seyahat Fotoğrafçısı</title>
    <!-- Tailwind CSS Yükleniyor -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font kullanıyoruz */
        body { font-family: "Inter", sans-serif; }
        /* Özel animasyon */
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .animate-pulse-once {
            animation: pulse-once 0.3s ease-in-out;
        }
        /* Yükleme animasyonunu tam ortalamak için */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
        }
        /* Görselin uzun basıldığında/sağ tıklandığında indirilmesini engellememek için */
        #generated-image {
            user-select: auto; 
            -webkit-touch-callout: default; /* iOS Safari için */
        }
        .drop-area-active {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-6">

    <header class="text-center mb-6 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera w-8 h-8 mr-2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            Gemini Sanal Seyahat Fotoğrafçısı
        </h1>
        <p class="text-gray-500 mt-2">Kendi fotoğrafınızı seçtiğiniz bir seyahat harikasına, yüz benzerliğini koruyarak yerleştirin.</p>
    </header>

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-2xl relative">
        
        <!-- Hata Mesaj Alanı -->
        <div id="error-message" class="hidden mt-4 mb-4 text-center text-red-600 bg-red-100 border border-red-300 p-3 rounded-xl font-medium shadow-md"></div>
        
        <!-- Yükleme Kaplaması -->
        <div id="loading-overlay" class="hidden flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-50 rounded-2xl">
            <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-indigo-700 font-semibold">Görsel Oluşturuluyor...</p>
            <p class="text-sm text-gray-500 mt-1">Bu işlem 10-20 saniye sürebilir. Lütfen sabırlı olun.</p>
        </div>

        <!-- Adım 1: Fotoğraf Yükleme -->
        <div class="flex items-center space-x-2 my-4">
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">1</div>
            <h2 class="text-xl font-bold text-gray-800">Kendi Fotoğrafınızı Yükleyin (Yüksek Yüz Benzerliği İçin Net Yüz Gerekir)</h2>
        </div>
        
        <div class="max-w-md mx-auto">
            <!-- FOTOĞRAF Yükleme Alanı -->
            <div>
                <div
                    id="drop-area"
                    class="p-6 border-2 border-dashed border-gray-300 rounded-xl text-center transition duration-300 cursor-pointer hover:drop-area-active"
                    onclick="document.getElementById('file-upload').click()"
                >
                    <div id="image-preview" class="hidden relative">
                        <img id="uploaded-image" src="" alt="Yüklenen Fotoğraf Önizleme" class="mx-auto max-h-48 object-contain rounded-lg shadow-md" />
                        <button
                            id="remove-image-btn"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-700 transition z-10"
                            aria-label="Fotoğrafı Kaldır"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div id="upload-prompt" class="text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image w-8 h-8 mx-auto mb-2 text-indigo-500"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        <p class="font-medium">Sürükleyip bırakın veya tıklayın.</p>
                        <p class="text-sm">Yüzünüzün net olduğu bir fotoğraf yükleyin</p>
                    </div>
                    <input id="file-upload" type="file" accept="image/png, image/jpeg" class="hidden" />
                </div>
            </div>
        </div>
        
        <hr class="my-8 border-gray-200" />

        <!-- Adım 2: Harika Seçimi -->
        <div class="flex items-center space-x-2 my-4">
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">2</div>
            <h2 class="text-xl font-bold text-gray-800">Dünyanın Harikasını Seçin</h2>
        </div>
        <div id="wonder-selection" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <!-- Wonder butonları JS ile doldurulacak -->
        </div>

        <hr class="my-8 border-gray-200" />

        <!-- Adım 3: Çekim Tipi Seçimi -->
        <div class="flex items-center space-x-2 my-4">
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">3</div>
            <h2 class="text-xl font-bold text-gray-800">Çekim Tipi Seçeneği</h2>
        </div>
        <div class="flex space-x-4 justify-center">
            <button id="selfie-btn" data-shot="selfie" class="shot-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-blue-500 text-white border-blue-700 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-smile"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                <span class="font-medium">Yakın Çekim (Selfie Tarzı)</span>
            </button>
            <button id="normal-btn" data-shot="normal" class="shot-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-white text-gray-700 border-gray-300 hover:border-green-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                <span class="font-medium">Uzak Çekim (Boydan Görünüm)</span>
            </button>
        </div>
        
        <hr class="my-8 border-gray-200" />

        <!-- Adım 4: Mevsim Seçeneği -->
        <div class="flex items-center space-x-2 my-4">
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">4</div>
            <h2 class="text-xl font-bold text-gray-800">Mevsim Seçeneği</h2>
        </div>
        <div class="flex space-x-4 justify-center">
            <button id="summer-btn" data-season="summer" class="season-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-yellow-500 text-white border-yellow-700 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <span class="font-medium">Yaz (Güneşli, Açık Hava)</span>
            </button>
            <button id="winter-btn" data-season="winter" class="season-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-white text-gray-700 border-gray-300 hover:border-blue-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cloud-snow"><path d="M20 17.68A5 5 0 0 0 18 10h-1.26A8 8 0 1 0 4 15.25"></path><line x1="8" y1="16" x2="8.01" y2="16"></line><line x1="8" y1="20" x2="8.01" y2="20"></line><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="22" x2="12.01" y2="22"></line><line x1="16" y1="16" x2="16.01" y2="16"></line><line x1="16" y1="20" x2="16.01" y2="20"></line></svg>
                <span class="font-medium">Kış (Karlı, Soğuk Hava)</span>
            </button>
        </div>


        <hr class="my-8 border-gray-200" />

        <!-- Adım 5: Oluşturma -->
        <div class="text-center">
            <button id="generate-btn" class="flex items-center justify-center space-x-2 px-6 py-3 font-bold rounded-xl transition-all duration-200 shadow-xl bg-indigo-600 hover:bg-indigo-700 text-white active:scale-[0.98] mx-auto min-w-[250px] h-12" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-wand"><polyline points="22 2 15 9 8 2 1 9 8 16 15 9 22 2"></polyline><path d="M12 2v20"></path></svg>
                <span>Sanal Seyahati Başlat!</span>
            </button>
        </div>

        <!-- Sonuç Alanı -->
        <hr class="my-8 border-gray-200" />

        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image w-6 h-6 mr-2 text-indigo-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            Oluşturulan Görsel
        </h2>

        <div id="result-container" class="bg-gray-100 min-h-64 rounded-xl flex items-center justify-center overflow-hidden shadow-inner aspect-video">
            <p id="result-placeholder" class="text-gray-500 p-4">Sonuç burada görünecektir. Fotoğraf yüklediğinizden emin olun.</p>
            <img id="generated-image" src="" alt="Sanal Seyahat Sonucu" class="hidden w-full h-full object-contain" />
        </div>
        
        <!-- Manuel Kaydetme Talimatı -->
        <div id="action-buttons" class="hidden mt-6">
            <h3 class="text-center text-xl font-bold text-indigo-700 mb-4">Sanal Fotoğrafınız Hazır!</h3>
            
            <div class="text-center text-base text-gray-800 bg-indigo-50 border border-indigo-200 p-4 rounded-xl max-w-lg mx-auto font-medium shadow-md">
                <p class="font-bold text-indigo-800 mb-2">Görseli Kaydetmek veya Paylaşmak İçin:</p>
                <ul class="list-disc list-inside text-left mx-auto max-w-xs">
                    <li>**Mobil Cihazda:** Görselin üzerine **uzun basın** (basılı tutun).</li>
                    <li>**Masaüstünde:** Görselin üzerine **sağ tıklayın**.</li>
                </ul>
                <p class="mt-2 font-semibold">Ardından, çıkan menüden **"Görseli İndir/Kaydet"** veya **"Görseli Paylaş"** seçeneğini kullanın.</p>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-sm text-gray-400 mt-6 pb-4">
        Powered by Gemini 2.5 Flash for Image Generation
    </footer>

    <script type="module">
        // Zorunlu Firebase importları (Uygulamanın açılmasını sağlamak için)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ortamın gerektirdiği Firebase başlatma (Kullanılmasa bile gerekli)
        if (typeof __firebase_config !== 'undefined') {
             try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                getFirestore(app);
                getAuth(app); 
             } catch (e) {
                console.warn("Firebase initialization skipped to ensure application launch.");
             }
        }
        
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=";
        const API_KEY = "AIzaSyButgT-pV3XWkxodvEvy9xpJ4CzV2CL1PY"; // 

        const WONDERS = [
            { name: 'Çin Seddi', promptDetail: 'Great Wall of China, epic and vast landscape', icon: '⛰️' },
            { name: 'Petra (Ürdün)', promptDetail: 'The Treasury (Al-Khazneh) at Petra, inside the ancient canyon', icon: '🏛️' },
            { name: 'Kurtarıcı İsa Heykeli', promptDetail: 'Christ the Redeemer statue in Rio de Janeiro, with the city skyline below', icon: '🇧🇷' },
            { name: 'Machu Picchu', promptDetail: 'The high altitude ruins of Machu Picchu, surrounded by green mountains', icon: '🇵🇪' },
            { name: 'Kolezyum (Roma)', promptDetail: 'The ancient Roman Colosseum, dynamic interior view', icon: '🇮🇹' },
            { name: 'Tac Mahal', promptDetail: 'The white marble beauty of the Taj Mahal, reflected in the water channels', icon: '🇮🇳' },
            { name: 'Chichén Itzá', promptDetail: 'El Castillo pyramid at Chichén Itzá, sunny and clear day', icon: '🇲🇽' },
        ];

        // Tek kişi için durum değişkeni
        let uploadedImageBase64 = null;
        let selectedWonder = WONDERS[0];
        let shotType = 'selfie';
        let selectedSeason = 'summer'; 
        let generatedImageUrl = null;

        // --- DOM Elementleri ---
        const $errorMsg = document.getElementById('error-message');
        const $loadingOverlay = document.getElementById('loading-overlay');
        const $generateBtn = document.getElementById('generate-btn');
        const $wonderSelection = document.getElementById('wonder-selection');
        const $generatedImage = document.getElementById('generated-image');
        const $resultPlaceholder = document.getElementById('result-placeholder');
        const $actionButtons = document.getElementById('action-buttons');
        
        // Fotoğraf Elementleri (Tek set)
        const $fileUpload = document.getElementById('file-upload');
        const $uploadedImage = document.getElementById('uploaded-image');
        const $imagePreview = document.getElementById('image-preview');
        const $uploadPrompt = document.getElementById('upload-prompt');
        const $removeImageBtn = document.getElementById('remove-image-btn');
        const $dropArea = document.getElementById('drop-area');

        // Çekim/Mevsim Butonları
        const $selfieBtn = document.querySelector('[data-shot="selfie"]');
        const $normalBtn = document.querySelector('[data-shot="normal"]');
        const $summerBtn = document.querySelector('[data-season="summer"]'); 
        const $winterBtn = document.querySelector('[data-season="winter"]'); 

        // --- Yardımcı Fonksiyonlar ---

        function updateGenerateButtonState() {
            const isReady = uploadedImageBase64 !== null;
            $generateBtn.disabled = !isReady;
            if (!isReady) {
                $generateBtn.textContent = 'Lütfen fotoğrafınızı yükleyin';
            } else {
                $generateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-wand"><polyline points="22 2 15 9 8 2 1 9 8 16 15 9 22 2"></polyline><path d="M12 2v20"></path></svg> <span>Sanal Seyahati Başlat!</span>';
            }
        }

        function displayMessage(message, isError = false) {
            $errorMsg.textContent = message;
            if (isError) {
                 $errorMsg.classList.remove('hidden');
                 $errorMsg.className = 'mt-4 mb-4 text-center text-red-600 bg-red-100 border border-red-300 p-3 rounded-xl font-medium shadow-md animate-pulse-once';
            } else {
                 $errorMsg.classList.add('hidden');
            }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                $loadingOverlay.classList.remove('hidden');
                $loadingOverlay.classList.add('flex');
                $generateBtn.disabled = true;
                $generateBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Oluşturuluyor...</span>';
            } else {
                $loadingOverlay.classList.add('hidden');
                $loadingOverlay.classList.remove('flex');
                updateGenerateButtonState();
            }
        }

        function handleFileUpload(file) {
            displayMessage('', false);
            if (!file || !file.type.startsWith('image/')) {
                displayMessage('Lütfen geçerli bir görsel dosyası yükleyin.', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Part = e.target.result.split(',')[1];
                
                uploadedImageBase64 = base64Part; 
                $uploadedImage.src = e.target.result;
                $imagePreview.classList.remove('hidden');
                $uploadPrompt.classList.add('hidden');
                
                generatedImageUrl = null;
                $generatedImage.classList.add('hidden');
                $resultPlaceholder.classList.remove('hidden');
                $actionButtons.classList.add('hidden');

                updateGenerateButtonState();
            };
            reader.onerror = () => {
                displayMessage('Dosya okuma hatası.', true);
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImageBase64 = null;
            $uploadedImage.src = '';
            $imagePreview.classList.add('hidden');
            $uploadPrompt.classList.remove('hidden');
            
            generatedImageUrl = null;
            $generatedImage.classList.add('hidden');
            $resultPlaceholder.classList.remove('hidden');
            $actionButtons.classList.add('hidden');
            displayMessage('', false);
            updateGenerateButtonState();
        }

        function updateSeasonTypeUI(newSeasonType) {
            selectedSeason = newSeasonType;
            if (newSeasonType === 'summer') {
                $summerBtn.className = 'season-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-yellow-500 text-white border-yellow-700 shadow-lg';
                $winterBtn.className = 'season-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-white text-gray-700 border-gray-300 hover:border-blue-400';
            } else {
                $summerBtn.className = 'season-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-white text-gray-700 border-gray-300 hover:border-yellow-400';
                $winterBtn.className = 'season-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-blue-500 text-white border-blue-700 shadow-lg';
            }
        }
        
        function updateShotTypeUI(newShotType) {
            shotType = newShotType;
            if (newShotType === 'selfie') {
                $selfieBtn.className = 'shot-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-blue-500 text-white border-blue-700 shadow-lg';
                $normalBtn.className = 'shot-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-white text-gray-700 border-gray-300 hover:border-green-400';
            } else {
                $selfieBtn.className = 'shot-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-white text-gray-700 border-gray-300 hover:border-blue-400';
                $normalBtn.className = 'shot-type-btn flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 border-2 w-1/2 bg-green-500 text-white border-green-700 shadow-lg';
            }
        }


        // --- Core İşleyiciler ---

        async function generateImage() {
            if (!uploadedImageBase64) {
                displayMessage('Lütfen bir fotoğraf yükleyin.', true);
                return;
            }

            setLoading(true);
            displayMessage('', false);
            
            const shotDescription = shotType === 'selfie'
                ? 'a close-up selfie angle, showing the person\'s face clearly with the landmark filling the background.'
                : 'a full-body portrait shot of the person standing in the scene.';
                
            const seasonPrompt = selectedSeason === 'summer'
                ? 'The environment should be sunny, bright, and warm. The person should be wearing appropriate summer or light clothing (e.g., shorts, t-shirt, light dress).'
                : 'The environment should feature winter weather (e.g., snow, frost, cloudy sky). The person must be wearing heavy winter clothes (e.g., coat, hat, gloves, scarf). Ensure the clothing is appropriate for cold weather.';


            // Yüz benzerliğini maksimize etmek için System Prompt (tek kişi için)
            const systemPrompt = "You are an expert AI photo compositor. Your primary instruction is to achieve **maximum fidelity** between the **face and unique identity** of the person in the input image and the person in the generated output. The person must be placed seamlessly in the scene with perfectly matched lighting, shadow, and perspective. Preserve the person's clothes/pose as much as possible while integrating them into the new environment. The result must be a high-resolution, photorealistic travel photograph.";

            // Yüz benzerliğini vurgulayan User Query
            const userQuery = `Integrate the single person from the provided image into a hyper-realistic, high-definition, 16:9 aspect ratio scene at **${selectedWonder.promptDetail}**. **Maximum facial resemblance to the uploaded person is mandatory.** The shot style should be **${shotDescription}**. **${seasonPrompt}** The final image must be of a single person at the landmark.`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            // Tek partner görseli
                            {
                                inlineData: {
                                    mimeType: "image/png",
                                    data: uploadedImageBase64
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseModalities: ['IMAGE'],
                    imageGenerationConfig: {
                        numberOfImages: 1,
                        aspectRatio: "16:9",
                    }
                },
                model: "gemini-2.5-flash-image-preview"
            };

            let attempt = 0;
            const maxRetries = 3;
            let success = false;

            while (attempt < maxRetries && !success) {
                attempt++;
                try {
                    const response = await fetch(API_URL + API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API isteği başarısız oldu: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        generatedImageUrl = `data:image/png;base64,${base64Data}`;
                        $generatedImage.src = generatedImageUrl;
                        $generatedImage.classList.remove('hidden');
                        $resultPlaceholder.classList.add('hidden');
                        $actionButtons.classList.remove('hidden');
                        success = true;
                    } else {
                        throw new Error("Görsel verisi alınamadı.");
                    }
                } catch (error) {
                    console.error(`Görsel oluşturma hatası (Deneme ${attempt}):`, error);
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        displayMessage('Üzgünüm, görsel oluşturulamadı. Üç denemeye rağmen API’dan yanıt alınamadı. Lütfen bir dakika bekleyip tekrar deneyin.', true);
                    }
                }
            }
            setLoading(false); 
        }

        // --- Başlatma (DOM Ready) ---

        window.onload = function() {
            // Wonder Butonlarını Oluştur
            WONDERS.forEach((wonder, index) => {
                const btn = document.createElement('button');
                btn.className = `wonder-btn flex flex-col items-center justify-center p-3 sm:p-4 rounded-xl text-center transition-all duration-200 border-2 shadow-sm ${index === 0 ? 'bg-indigo-600 text-white border-indigo-700 scale-[1.02] shadow-indigo-300/50' : 'bg-white text-gray-700 border-gray-200 hover:border-indigo-400'}`;
                btn.innerHTML = `<span class="text-2xl mb-1">${wonder.icon}</span><span class="text-sm font-medium">${wonder.name}</span>`;
                btn.setAttribute('data-index', index);
                $wonderSelection.appendChild(btn);
            });

            // --- Event Dinleyicileri ---

            // 1. Dosya Yükleme Dinleyicileri
            $fileUpload.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

            $removeImageBtn.addEventListener('click', (e) => { e.stopPropagation(); removeImage(); });

            // Drag and Drop Dinleyicileri 
            $dropArea.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                e.stopPropagation(); 
                $dropArea.classList.add('drop-area-active');
            });
            $dropArea.addEventListener('dragleave', (e) => { 
                e.preventDefault(); 
                e.stopPropagation(); 
                $dropArea.classList.remove('drop-area-active');
            });
            $dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                $dropArea.classList.remove('drop-area-active');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                    $fileUpload.files = e.dataTransfer.files; // Dosyayı file input'a da ekle
                }
            });


            // 2. Wonder Seçim Dinleyicileri
            document.querySelectorAll('.wonder-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.wonder-btn').forEach(b => {
                        b.className = 'wonder-btn flex flex-col items-center justify-center p-3 sm:p-4 rounded-xl text-center transition-all duration-200 border-2 shadow-sm bg-white text-gray-700 border-gray-200 hover:border-indigo-400';
                    });
                    e.currentTarget.className = 'wonder-btn flex flex-col items-center justify-center p-3 sm:p-4 rounded-xl text-center transition-all duration-200 border-2 shadow-sm bg-indigo-600 text-white border-indigo-700 scale-[1.02] shadow-indigo-300/50';
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    selectedWonder = WONDERS[index];
                });
            });

            // 3. Çekim Tipi Dinleyicileri
            $selfieBtn.addEventListener('click', () => updateShotTypeUI('selfie'));
            $normalBtn.addEventListener('click', () => updateShotTypeUI('normal'));
            
            // 4. Mevsim Seçimi Dinleyicileri
            $summerBtn.addEventListener('click', () => updateSeasonTypeUI('summer'));
            $winterBtn.addEventListener('click', () => updateSeasonTypeUI('winter'));

            // 5. Oluşturma Dinleyicisi
            $generateBtn.addEventListener('click', generateImage);

            // Başlangıç durumu ayarı
            updateGenerateButtonState();
        };
    </script>
</body>
</html>